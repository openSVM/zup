FROM debian:bullseye-slim

# Install required packages
RUN apt-get update && apt-get install -y \
    wget \
    xz-utils \
    procps \
    strace \
    && rm -rf /var/lib/apt/lists/*

# Install Zig
RUN wget https://ziglang.org/download/0.11.0/zig-linux-x86_64-0.11.0.tar.xz \
    && tar xf zig-linux-x86_64-0.11.0.tar.xz \
    && mv zig-linux-x86_64-0.11.0 /usr/local/zig \
    && rm zig-linux-x86_64-0.11.0.tar.xz

# Set up environment
ENV PATH="/usr/local/zig:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
ENV ZIG_DEBUG_LOG=debug
ENV RUST_BACKTRACE=1

WORKDIR /app
COPY . .

# Make scripts executable
RUN chmod +x scripts/*.sh

# Pre-build to catch any build errors early
RUN zig build test -Doptimize=Debug || (cat zig-cache/log.txt && exit 1)

# Default command (can be overridden)
CMD ["./scripts/run_grpc_tests_local.sh"]
